<!doctype html>
<meta charset="utf-8">
<title>Messages</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/web/messages.css">
<link rel="preload" href="/fonts/Voice1.woff2" as="font" type="font/woff2" crossorigin>

<div class="wrap">
    <aside class="left">
        <div class="head">Direct Messages</div>
        <div class="tools">
            <input id="conv-q" class="search-input" placeholder="Search conversations…">
            <button id="btn-newdm" class="iconbtn" title="Start a conversation"><img src="/web/icons/new-dm.png" alt="+"></button>
            <button id="btn-newgroup" class="iconbtn" title="Create a group"><img src="/web/icons/new-group.png" alt="◎"></button>
        </div>
        <div id="convs"></div>
    </aside>

    <main class="right">
        <div class="chat-head">
            <img id="chat-pfp" class="chat-pfp" src="/web/default-avatar.png" alt="">
            <div class="chat-title" id="chat-title">Pick a conversation</div>
            <div class="spacer"></div>
            <button id="chat-menu-btn" class="iconbtn" title="Options">⋮</button>
            <div id="chat-menu" class="menu"></div>
        </div>

        <div class="msgs" id="msgs">
            <div id="pad-top"></div>
            <button id="jump" class="jump btn" style="display:none">Jump to present ↓</button>
            <div id="pad-bottom"></div>
        </div>

        <div class="composer">
            <div>
                <textarea id="text" maxlength="10000" placeholder="Message…"></textarea>
                <div class="chips" id="att-chips"></div>
                <div class="warn" id="rec-warn" style="display:none"></div>
            </div>
            <div class="col">
                <button class="btn" id="btn-attach">Attach</button>
                <button class="btn" id="btn-voice">Hold to record</button>
                <button class="btn" id="btn-send">Send</button>
                <input type="file" id="file" multiple style="display:none">
            </div>
        </div>
    </main>
</div>

<!-- People picker overlay (DM / group create / edit / view) -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet" id="sheet">
        <h3 id="sheet-title">Start a conversation</h3>
        <div class="picker-bar">
            <input id="user-q" class="search-input" placeholder="Search friends…">
        </div>
        <div id="user-list" class="list"></div>
        <div class="bottom-center" id="group-cta" style="display:none">
            <div id="selected-chips"></div>
            <div style="display:flex; gap:8px;">
                <button class="btn" id="btn-cancel">Cancel</button>
                <button class="btn" id="btn-group-submit" disabled>Create Group</button>
            </div>
        </div>
    </div>
</div>

<script src="/web/vendor/ffmpeg/umd/ffmpeg.js"></script>
<script src="/web/messages/compressors.js"></script>
<script src="/web/messages/ui-overlays.js"></script>
<script src="/web/messages/core.js"></script>
<script src="/web/messages/audio.js"></script>
<script src="/web/messages/attachments.js"></script>
<script src="/web/messages/chat.js"></script>
<script src="/web/messages/wiring.js"></script>

<script>
    (function bootMessagesApp() {
        function boot() {
            try {
                if (!window.MessagesApp || !window.MessagesApp.boot) {
                    throw new Error('MessagesApp.boot is missing. Check that core.js, chat.js, and wiring.js loaded without 404s.');
                }
                window.MessagesApp.boot();
                console.log('✅ MessagesApp booted');
            } catch (e) {
                console.error('❌ Boot failed:', e);
                alert('Boot failed: ' + (e && e.message ? e.message : e));
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', boot);
        } else {
            boot();
        }
    })();
</script>

<script>
    const API = 'http://localhost:3000/api';
    /* ---------- SAFETY: prevent auto-downloads from media tags ---------- */
    (() => {
        // Escape a string for use inside a new RegExp
        const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        // Any direct media src at this endpoint will be intercepted
        const ATT_RX = new RegExp('^' + escRe(API) + '/dm/attachments/\\d+/download');

        // Wrap setAttribute on IMG/VIDEO/AUDIO to turn "src" → safe blob URL
        const targets = [window.HTMLImageElement, window.HTMLVideoElement, window.HTMLAudioElement].filter(Boolean);

        async function safeSwapSrc(el, url) {
            try {
                // Use your existing helper that also auto-gunzips when needed
                const blob = await fetchBlobMaybeGunzip(url, el.getAttribute('data-filename') || '');
                const obj = URL.createObjectURL(blob);
                el.src = obj;
                el.dataset.objurl = obj; // revokeObjectURLsIn() already cleans these up
            } catch {
                // If we can’t fetch safely, leave src unset.
                // Your renderers/menus already provide explicit download links.
            }
        }

        for (const Ctor of targets) {
            const _setAttr = Ctor.prototype.setAttribute;
            Ctor.prototype.setAttribute = function (name, value) {
                if (name === 'src' && typeof value === 'string' && ATT_RX.test(value)) {
                    // Prevent direct navigation to the download URL
                    // (which can trigger auto-save on some browsers)
                    // Use a data attr as a breadcrumb for debugging
                    _setAttr.call(this, 'data-safe-src', value);
                    // Ensure src is blank until we swap to a blob URL
                    try { this.removeAttribute('src'); } catch { }
                    // Kick off the safe fetch → object URL
                    safeSwapSrc(this, value);
                    return;
                }
                return _setAttr.call(this, name, value);
            };
        }
    })();
</script>