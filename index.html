<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Daily Plea (7/8/25)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 1) Main content container -->
    <div class="container">
        <p>
            <span class="section plea-number">Plea #2:</span>
            <span class="section">
                As the sky parted once more, the trees began to slow their sway and the birds' chirps once again became audible.
            </span>
            <span class="section">
                The grass, soaked with the sky's moisture, was greener than ever and greeted all those who crawled up from beneath its roots.
            </span>
            <span class="section">
                The air was humid, but not so much so that it was overwhelming, or hard to breathe. Just enough to mix up breathing in from out.
            </span>
            <span class="section">
                It was peaceful. Nature was as it should be. Natural.
            </span><br>
            <span class="section">
                Then a faint whistling sound could be heard. It was unlike any native bird's whistle... It was constant. Foreboding.
            </span>
            <span class="section">
                It grew louder. The pitch dropped slowly.
            </span>
            <span class="section">
                Then it grew even louder. The pitch continuing to lower.
            </span>
            <span class="section">
                Then louder. Now enough to disturb the field.
            </span>
            <span class="section">
                The animals began to flee one by one, the bugs retreating into the dirt, then suddenly a great flash filled the sky before rapidly engulfing the field.
            </span><br><br>
            <span class="section">
                it was a nuke.
            </span><br><br>
            <span class="section">
                the animals all died.
            </span><br><br><br>
            <span class="section">
                the end.
            </span>
        </p>
    </div>

    <!-- 2) Continue prompt -->
    <div id="continue-prompt">Continue..?</div>

    <!-- 3) Full-screen start overlay -->
    <div id="start-overlay">
        <span id="start-text">Connect?</span><span id="ellipsis"></span>
    </div>

    <!-- 4) Inline animation + audio script -->
    <script>
        // grab elements
        const container = document.querySelector('.container');
        const sections = container.querySelectorAll('.container .section');
        const animateSections = Array.from(sections).slice(1);
        const prompt = document.getElementById('continue-prompt');
        const startOverlay = document.getElementById('start-overlay');
        const startText = document.getElementById('start-text');
        const ellipsis = document.getElementById('ellipsis');

        // reset scroll
        container.scrollTo({ top: 0, behavior: 'auto' });

        // audio setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const volumeNode = audioCtx.createGain();
        volumeNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
        volumeNode.connect(audioCtx.destination);

        let clickBuffer = null;
        let resumed = false;
        let started = false;

        fetch('sounds/Voice1Hum.wav')
            .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.arrayBuffer(); })
            .then(data => audioCtx.decodeAudioData(data))
            .then(buf => { clickBuffer = buf; })
            .catch(err => console.error('Audio load failed:', err));

        function playClick() {
            if (!clickBuffer || !resumed) return;
            const src = audioCtx.createBufferSource();
            src.buffer = clickBuffer;
            src.connect(volumeNode);
            src.start();
        }

        // fade in "Connect?"
        requestAnimationFrame(() => {
            startText.classList.add('visible');
        });

        // wrap chars
        animateSections.forEach(section => {
            const raw = section.textContent;
            section.textContent = '';
            Array.from(raw).forEach(ch => {
                if (ch === ' ') {
                    section.appendChild(document.createTextNode(' '));
                } else {
                    const span = document.createElement('span');
                    span.textContent = ch;
                    span.className = 'char';
                    section.appendChild(span);
                }
            });
        });

        let current = 0;
        let revealing = false;
        let timeouts = [];
        let promptTimer = null;

        const hidePrompt = () => {
            clearTimeout(promptTimer);
            prompt.classList.remove('visible');
        };

        const schedulePrompt = idx => {
            clearTimeout(promptTimer);
            const delay = idx === 0 ? 2500 : 6000;
            promptTimer = setTimeout(() => prompt.classList.add('visible'), delay);
        };

        const revealSection = idx => {
            revealing = true;
            const chars = animateSections[idx].querySelectorAll('.char');
            const BASE_SPEED = 30;
            const PERIOD_PAUSE = 300;
            let accDelay = 0;

            timeouts.forEach(clearTimeout);
            timeouts = [];

            chars.forEach(c => {
                const id = setTimeout(() => {
                    c.classList.add('visible');
                    playClick();

                    // consistent container scroll
                    const gutter = container.clientHeight * 0.2;
                    const charBottom = c.offsetTop + c.clientHeight;
                    const visibleBottom = container.scrollTop + container.clientHeight - gutter;
                    if (charBottom > visibleBottom) {
                        const target = charBottom - (container.clientHeight - gutter);
                        container.scrollTo({ top: target, behavior: 'smooth' });
                    }

                    if (c === chars[chars.length - 1]) {
                        revealing = false;
                        if (idx < animateSections.length - 1) schedulePrompt(idx);
                    }
                }, accDelay);

                timeouts.push(id);
                accDelay += BASE_SPEED;
                if (c.textContent === '.') accDelay += PERIOD_PAUSE;
            });
        };

        async function doStartFlow() {
            startText.textContent = 'Connecting';
            ellipsis.textContent = '';
            for (let i = 0; i < 3; i++) {
                await new Promise(r => setTimeout(r, 300));
                ellipsis.textContent += '.';
            }
            await new Promise(r => setTimeout(r, Math.random() * 2000 + 1000));
            startText.textContent = '';
            ellipsis.textContent = '';
            await new Promise(r => setTimeout(r, 1000));
            startOverlay.classList.add('hidden');
            await new Promise(r => setTimeout(r, 1000));
            revealSection(0);
            current = 1;
        }

        function onStart(e) {
            e.preventDefault();
            if (started) return;
            started = true;
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(console.error);
            resumed = true;
            doStartFlow();
        }

        startOverlay.addEventListener('pointerdown', onStart, { once: true });
        startOverlay.addEventListener('touchstart', onStart, { once: true, passive: false });
        startOverlay.addEventListener('click', onStart, { once: true });

        container.addEventListener('click', () => {
            hidePrompt();
            if (current >= animateSections.length) return;
            if (revealing) {
                timeouts.forEach(clearTimeout);
                animateSections[current - 1]
                    .querySelectorAll('.char')
                    .forEach(c => c.classList.add('visible'));
                revealing = false;
            }
            revealSection(current);
            current++;
        });
    </script>
</body>
</html>
